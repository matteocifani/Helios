create table public.abitazioni (
  id serial not null,
  codice_cliente integer not null,
  via character varying(255) null,
  civico character varying(20) null,
  citta character varying(100) null,
  cap character varying(10) null,
  provincia character varying(50) null,
  paese character varying(100) null default 'Italia'::character varying,
  indirizzo_completo text null,
  latitudine numeric(10, 8) null,
  longitudine numeric(11, 8) null,
  fonte_dati character varying(100) null,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  metratura numeric(10, 2) null,
  sistema_allarme boolean null default false,
  zona_sismica character varying(5) null,
  hydro_risk_p3 numeric(10, 3) null,
  hydro_risk_p2 numeric(10, 3) null,
  flood_risk_p4 numeric(10, 3) null,
  flood_risk_p3 numeric(10, 3) null,
  solar_potential_kwh numeric(10, 2) null,
  solar_coverage_percent integer null,
  solar_savings_euro integer null,
  high_solar_potential boolean null default false,
  risk_score integer null,
  high_risk_property boolean null default false,
  risk_category character varying(20) null,
  constraint abitazioni_pkey primary key (id),
  constraint abitazioni_codice_cliente_key unique (codice_cliente),
  constraint abitazioni_codice_cliente_fkey foreign KEY (codice_cliente) references clienti (codice_cliente) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists abitazioni_citta_idx on public.abitazioni using btree (citta) TABLESPACE pg_default;

create index IF not exists abitazioni_cap_idx on public.abitazioni using btree (cap) TABLESPACE pg_default;

create index IF not exists abitazioni_coordinates_idx on public.abitazioni using btree (latitudine, longitudine) TABLESPACE pg_default;

create index IF not exists idx_abitazioni_citta on public.abitazioni using btree (lower((citta)::text)) TABLESPACE pg_default;

create index IF not exists idx_abitazioni_risk on public.abitazioni using btree (risk_score desc) TABLESPACE pg_default
where
  (risk_score is not null);

create index IF not exists idx_abitazioni_solar on public.abitazioni using btree (high_solar_potential) TABLESPACE pg_default
where
  (high_solar_potential = true);

create table public.clienti (
  codice_cliente integer not null,
  nome text not null,
  cognome text not null,
  eta integer null,
  luogo_nascita text null,
  luogo_residenza text null,
  professione text null,
  reddito numeric(12, 2) null,
  reddito_familiare numeric(12, 2) null,
  numero_figli integer null default 0,
  anzianita_compagnia integer null,
  stato_civile text null,
  numero_familiari_carico integer null,
  reddito_stimato numeric(12, 2) null,
  patrimonio_finanziario_stimato numeric(15, 2) null,
  patrimonio_reale_stimato numeric(15, 2) null,
  consumi_stimati numeric(12, 2) null,
  propensione_vita double precision null,
  propensione_danni double precision null,
  valore_immobiliare_medio numeric(15, 2) null,
  probabilita_furti double precision null,
  probabilita_rapine double precision null,
  zona_residenza text null,
  agenzia text null,
  latitudine double precision null,
  longitudine double precision null,
  num_polizze integer null,
  engagement_score double precision null,
  churn_probability double precision null,
  clv_stimato numeric(12, 2) null,
  potenziale_crescita double precision null,
  reclami_totali integer null default 0,
  satisfaction_score double precision null,
  data_ultima_visita date null,
  visite_ultimo_anno integer null,
  cluster_risposta text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint clienti_pkey primary key (codice_cliente)
) TABLESPACE pg_default;

create index IF not exists idx_clienti_geo on public.clienti using btree (latitudine, longitudine) TABLESPACE pg_default;

create index IF not exists idx_clienti_agenzia on public.clienti using btree (agenzia) TABLESPACE pg_default;

create table public.interactions (
  id serial not null,
  codice_cliente integer null,
  data_interazione date null,
  tipo_interazione character varying(100) null,
  motivo character varying(255) null,
  esito character varying(100) null,
  note text null,
  text_embedded text null,
  embedding public.vector null,
  dedup_key character varying(255) null,
  created_at timestamp without time zone null default now(),
  constraint interactions_pkey primary key (id),
  constraint interactions_dedup_key_key unique (dedup_key),
  constraint interactions_codice_cliente_fkey foreign KEY (codice_cliente) references clienti (codice_cliente)
) TABLESPACE pg_default;

create index IF not exists interactions_embedding_idx on public.interactions using ivfflat (embedding vector_cosine_ops)
with
  (lists = '100') TABLESPACE pg_default;

create index IF not exists interactions_cliente_idx on public.interactions using btree (codice_cliente) TABLESPACE pg_default;

create table public.polizze (
  id bigint generated by default as identity not null,
  codice_cliente integer not null,
  prodotto text not null,
  area_bisogno text null,
  data_emissione date null,
  data_scadenza date null,
  premio_ricorrente numeric(10, 2) null,
  premio_unico numeric(12, 2) null,
  capitale_rivalutato numeric(12, 2) null,
  massimale numeric(15, 2) null,
  stato_polizza text null,
  canale_acquisizione text null,
  commissione_perc double precision null,
  premio_totale_annuo numeric(10, 2) null,
  commissione_euro numeric(10, 2) null,
  costi_operativi numeric(10, 2) null,
  margine_lordo numeric(10, 2) null,
  importo_liquidato numeric(12, 2) null,
  sinistri_totali integer null,
  loss_ratio double precision null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint polizze_pkey primary key (id),
  constraint unique_polizza unique (codice_cliente, prodotto, data_emissione),
  constraint polizze_codice_cliente_fkey foreign KEY (codice_cliente) references clienti (codice_cliente) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_polizze_prodotto on public.polizze using btree (prodotto) TABLESPACE pg_default;

create index IF not exists idx_polizze_scadenza on public.polizze using btree (data_scadenza) TABLESPACE pg_default;

create index IF not exists idx_polizze_cliente on public.polizze using btree (codice_cliente) TABLESPACE pg_default;

create table public.sinistri (
  codice_cliente integer not null,
  data_sinistro date not null,
  tipologia_sinistro text not null,
  prodotto text null,
  area_bisogno text null,
  importo_liquidato numeric null,
  stato_liquidazione text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  constraint unique_sinistro primary key (codice_cliente, data_sinistro, tipologia_sinistro),
  constraint sinistri_codice_cliente_fkey foreign KEY (codice_cliente) references clienti (codice_cliente) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_sinistri_stato on public.sinistri using btree (stato_liquidazione) TABLESPACE pg_default;

create index IF not exists idx_sinistri_prodotto on public.sinistri using btree (prodotto) TABLESPACE pg_default;